<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <script src="../js/landline.js"></script>
    <script src="../js/landline.stateline.js"></script>
    <script src="../js/jquery.js"></script>
    <script src="../js/underscore-min.js"></script>
    <script src="../js/raphael-min.js"></script>
    <script src="states_options.js"></script>
    <script src="states_packaged.js"></script>
    <script src="state_data.js"></script>

    <!-- Create a tooltip container -->
    <script type="text/jst" id="landline_tooltip_tmpl">
      <h2><%= n %></h2>
      <span class='tooltip_jobspercap'>
        <%= jobspercap %>
      </span>
      <br>
      <span class='tooltip_textnorm'>
        solar jobs per million residents
      </span>
        <br>
      <span class='tooltip_textsmall'>
        2013 Solar Jobs: 
        <%= jobcount %>
        <br>
        2010 Census Population:
        <%= pop %>
      </span>
    </script>



  </head>
  <body>
    <div id="landline_container"></div>
    <script>
      $(function() {

        // Initialize the map
        var map = new Landline.Stateline("#landline_container", "states", options);
        
        // Set up the tooltip template
        var tmpl = _.template($("#landline_tooltip_tmpl").html());

        // Add tooltips, and cache the existing style
        // to put it back in place on mouseout
        map.on('mouseover', function(e, path, data) {
          data.existingStyle = (data.existingStyle || {});
          data.existingStyle["fill"]        = path.attr("fill");
          data.existingStyle["strokeWidth"] = path.attr("stroke-width");
          path.attr("fill", "#636363").attr("stroke-width", 1);
        });

        map.on('mousemove', function(e, path, data) {
          $("#landline_tooltip").html(tmpl({
              n           : data.get('n'), 
              jobcount    : numberWithCommas(solarjobs[data.fips][1]),
              pop         : numberWithCommas(solarjobs[data.fips][2]),
              jobspercap  : numberWithCommas(solarjobs[data.fips][3])
            })).css("left", e.pageX + 20).css("top", e.pageY + 20).show();
        });

        map.on('mouseout', function(e, path, data) {
          $("#landline_tooltip").hide();
          _(data.existingStyle).each(function(v, k) {
            path.attr(k, v);
          });
        });

        // define state categoricals
        var stateColor = function(jobs) {
          if (jobs < 187) return "rgb(254,227,145)";
          if (jobs < 274) return "rgb(254,196,79)";
          if (jobs < 345) return "rgb(254,153,41)";
          if (jobs < 706) return "rgb(236,112,20)";
          return "rgb(204,76,2)";
        };


        function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }; 

        // color states
        _(solarjobs).each(function(ary, fips) {
          map.style(fips, "fill", stateColor(ary[3]));
        })

        // Draw the map
        map.createMap();
      });
    </script>

    <div id="landline_tooltip"></div>
  </body>
</html>